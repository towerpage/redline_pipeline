# Redline Pipeline

## Description
This project implements a robust, LLM-powered pipeline for automated redlining and clause analysis of NDA documents. The first stage extracts individual clauses, maps them to a legal playbook using a two-stage (LLM + deterministic) matching process.  The second stage flags problematic clauses, generating suggested corrections, grounded in the playbook.  The last stage of the pipeline evaluates the quality of (a) problematic clause identification, and (b) suggested corrections by comparing system output against human reference, producing detailed, human-readable evaluation reports.

## Structure and Functionality
The Redline Pipeline is composed of three stages: **Clause Extraction**, **Redliner**, and **Evaluation**.  Internally, Redliner is composed of Playbook-to-NDA Mapper clause mapping logic and the actual Redliner logic.

### Clause Extraction
**Clause Extraction** is the initial stage of the pipeline.  Its job is to identify and extract all unique constituent clauses from the unstructured NDA (or other legal contract) document.  This stage ingests only the original TXT or RTF document, outputting a JSON containing a list of items corresponding to the identified clauses.  Each item contains a field for the raw text of the corresponding clause, labeled **clause_content**, and a field for the identified heading of the clause, labeled **clause_name**. 

Clause and heading extraction uses a combination of regular expressions and legal document structure heuristics.  No LLMs are utilized.

The script implementing **Clause Extraction** is **extract_clauses.py**, which requires an input contract document.  It generates an output file containing the individual clauses.  The output filename has "_clauses.json" appended to the original document's basename.

### Redliner
**Redliner** is the second (and main) stage of the pipeline.  This where all of the "AI" logic resides.  The following are the main steps executed by the Redliner stage.
- A mapping step produces a unique assignment between abstract “Playbook” clause types (such as "Indemnification", "Notices", etc.) and the actual NDA clauses identified in *Clause Extraction*.
- For each Playbook clause, the mapped NDA clause (or “None”) is retrieved for analysis.
- A prompt-driven LLM reviews the NDA clause in the context of the Playbook guidance.
- For any PROBLEMATIC clause, the pipeline generates a replacement/fix, drawing first from the Playbook’s “example_ideal_clause” or “example_fallback_clause”.

Thus, internally, **Redliner** is composed of **Playbook-to-NDA Mapper** *clause mapping logic* and the actual **Redliner** *problematic clause flagging and correction logic*.  **Playbook-to-NDA Mapper** uses an initial LLM-based step to generate a matrix of all pairwise match scores (Playbook × NDA clauses).  A second deterministic step systematically makes the final one-to-one assignments.  

*See the the short document* **Redline Pipeline Documentation** *for algorithm details.*

#### Playbook-to-NDA Mapper clause mapping logic files
The **Playbook-to-NDA Mapper** is implemented by script **generate_match_matrix.py**, which requires the Playbook and the extracted legal contract document clauses as inputs.  These must currently by set inside the script in the "Load Files" section.  As examples, default input file settings are playbook.json and bad_document_clauses.json.  Calling **generate_match_matrix.py** with the JSON list of desired legal contract clauses and appropriate Playbook generates a corresponding Playbook-to-NDA clause mapping.  Several intermediate output files are generated, but the one containing the final mapping and required downstream will be called **playbook_to_nda_mapping_second_pass_{timestamp}.json** (timestamp based on when it was executed.)

#### Redliner problematic clause flagging and correction logic files
The script implementing the **Redliner** problematic clause flagging and correction logic is **redline_nda.py**, which requires three inputs: the Playbook, the extracted legal contract document clauses, and the playbook-to-NDA clause mapping generated by the previous step. These must currently by set inside the script.  The Playbook and Clauses input files must be set in the "Load Inputs" section. As examples, default input file settings are playbook.json and bad_document_clauses.json.  The playbook-to-NDA clause mapping input file is set in the PLAYBOOK_TO_NDA_MAPPING_FILEPATH variable.  It should be set to an appropriate one generated by the previous step.  The final output of the **Redliner** is written to a file of the form **redlined_output_{timestamp}.json**.

### Evaluation
Evaluation is performed to rigorously compare the actual output of the redlining pipeline to the ground truth.  The script **evaluate_redlines.py** implements the evaluation logic.  It requires the extracted legal contract document clauses, the actual output generated by **Redline**, and ground truth expected output.  All three can be specified at the comman line when the script is called.

Evaluation results are printed to the screen.  
These include
- A concise evaluation block for each NDA clause, as such:

        Clause: 6. Disclosures Required by Law
        \- Expected:   Playbook: Disclosure required by Law | Flagged: YES
        \- Actual:     Playbook: Disclosure required by Law | Flagged: YES
        \- Text Snippet Similarity: 0.94
        \- Suggested Fix Similarity: 0.98
  
- TP/FP/FN/Precision/Recall/F1 for how well the Redline Pipeline matches the number of *NDA clauses* that should be flagged as problematic relative to expected.
- TP/FP/FN/Precision/Recall/F1 for how well the Redline Pipeline matches the number of *Playbook clauses* that should be flagged as problematic relative to expected.

*See the the short document* **Redline Pipeline Documentation** *for Evaluation details.*

## Requirements and Dependencies
There is a requirements.txt file in the distributionm specifying required libraries which must be installed prior to running any of the pipeline scripts.

Most of the pipeline scripts require a valid "OPENAI_API_KEY" to exist in a .env file in the project root directory.

## Usage
The scripts for each stage of the Redline Pipeline should be run in order, at least once for a given legal contract because output files are generated by intermediate stages which are required downstream.  

All scripts and data files are expected to be in the project root directory.

#### Clause Extraction
Usage: 
    
    python extract_clauses.py <path_to_contract.txt>

Example: 

    python extract_clauses.py bad_document.txt  --> bad_document_clauses.json

#### Redliner
Usage:

	python generate_match_matrix.py
	
	python evaluate_redlines.py
	
	
Example:

	python generate_match_matrix.py	 
		<set playbook.json and bad_document_clauses.json *intra-code*>
		--> playbook_to_nda_mapping_second_pass_20250912_024116.json
		
	python evaluate_redlines.py
		<set playbook.json, bad_document_clauses.json 
			and playbook_to_nda_mapping_second_pass_20250912_024116.json *intra-code*>
		--> redlined_output_20250912_024832.json

#### Evaluation
Usage: 

	python evaluate_redlines.py --expected <expected_output.json> --actual <actual_output.json> --clauses <contract_clauses.json>
	
Example:

	python evaluate_redlines.py --expected expected_output.json --actual redlined_output_20250912_024832.json --clauses bad_document_clauses.json

## Documentation
The **\documentation** subdirectory in the project directory contains a Word document called "Redline Pipeline Documentation v0.1".  The latest version is available here: https://docs.google.com/document/d/1CsrAlX7fsjSTzTFCOjkZOR6TcDmqmIf_gQwmqo_aUu4/edit?usp=sharing
